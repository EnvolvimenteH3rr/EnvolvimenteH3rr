name:CI/CDPipeline

on:
push:
branches:[main,develop]
pull_request:
branches:[main,develop]
workflow_dispatch:

env:
NODE_VERSION:'20.x'

jobs:
lint:
name:Lint&Format
runs-on:ubuntu-latest

steps:
-name:Checkoutcode
uses:actions/checkout@v4

-name:SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ”RunESLint
run:npmrunlint

-name:ðŸŽ¨CheckFormatting
run:npmrunformat:check
if:always()

-name:ðŸ“ŠUploadESLintReport
uses:actions/upload-artifact@v4
if:failure()
with:
name:eslint-report
path:eslint-report.json

#============================================
#Job2:TypeCheck(TypeScript)
#============================================
type-check:
name:ðŸ“TypeCheck
runs-on:ubuntu-latest

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ“RunTypeScriptCheck
run:npmruntype-check

#============================================
#Job3:UnitTests
#============================================
test:
name:ðŸ§ªUnitTests
runs-on:ubuntu-latest
strategy:
matrix:
node-version:[18.x,20.x,22.x]

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js${{matrix.node-version}}
uses:actions/setup-node@v4
with:
node-version:${{matrix.node-version}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ§ªRuntests
run:npmtest

-name:ðŸ“ŠUploadcoveragetoCodecov
uses:codecov/codecov-action@v4
if:matrix.node-version=='20.x'
with:
token:${{secrets.CODECOV_TOKEN}}
files:./coverage/lcov.info
flags:unittests
name:codecov-umbrella

#============================================
#Job4:Build
#============================================
build:
name:ðŸ—ï¸Build
runs-on:ubuntu-latest
needs:[lint,type-check]

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ—ï¸Buildproject
run:npmrunbuild

-name:ðŸ“¤Uploadbuildartifacts
uses:actions/upload-artifact@v4
with:
name:build-artifacts
path:dist/
retention-days:7

#============================================
#Job5:SecurityAudit
#============================================
security:
name:ðŸ”SecurityAudit
runs-on:ubuntu-latest

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}

-name:ðŸ”Runnpmaudit
run:npmaudit--audit-level=moderate
continue-on-error:true

-name:ðŸ”RunSnykSecurityScan
uses:snyk/actions/node@master
continue-on-error:true
env:
SNYK_TOKEN:${{secrets.SNYK_TOKEN}}
with:
args:--severity-threshold=high

#============================================
#Job6:DependencyReview
#============================================
dependency-review:
name:ðŸ“¦DependencyReview
runs-on:ubuntu-latest
if:github.event_name=='pull_request'

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ”DependencyReview
uses:actions/dependency-review-action@v4

#============================================
#Job7:CodeQLAnalysis
#============================================
codeql:
name:ðŸ•µï¸CodeQLAnalysis
runs-on:ubuntu-latest
permissions:
security-events:write
actions:read
contents:read

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ”§InitializeCodeQL
uses:github/codeql-action/init@v3
with:
languages:javascript,typescript

-name:ðŸ—ï¸Autobuild
uses:github/codeql-action/autobuild@v3

-name:ðŸ•µï¸PerformCodeQLAnalysis
uses:github/codeql-action/analyze@v3

#============================================
#Job8:PerformanceTests
#============================================
performance:
name:âš¡PerformanceTests
runs-on:ubuntu-latest
needs:[build]

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ“¥Downloadbuildartifacts
uses:actions/download-artifact@v4
with:
name:build-artifacts
path:dist/

-name:âš¡Runperformancetests
run:npmruntest:performance
continue-on-error:true

-name:ðŸ“ŠUploadperformanceresults
uses:actions/upload-artifact@v4
with:
name:performance-results
path:performance-results.json

#============================================
#Job9:E2ETests
#============================================
e2e:
name:ðŸŽ­E2ETests
runs-on:ubuntu-latest
needs:[build]

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¦SetupNode.js
uses:actions/setup-node@v4
with:
node-version:${{env.NODE_VERSION}}
cache:'npm'

-name:ðŸ“¥Installdependencies
run:npmci

-name:ðŸ“¥InstallPlaywright
run:npxplaywrightinstall--with-deps

-name:ðŸŽ­RunE2Etests
run:npmruntest:e2e

-name:ðŸ“¸Uploadtestscreenshots
uses:actions/upload-artifact@v4
if:failure()
with:
name:playwright-screenshots
path:test-results/

#============================================
#Job10:DeployPreview(PRs)
#============================================
deploy-preview:
name:ðŸš€DeployPreview
runs-on:ubuntu-latest
if:github.event_name=='pull_request'
needs:[build,test]
environment:
name:preview-${{github.event.number}}
url:${{steps.deploy.outputs.url}}

steps:
-name:ðŸ“¥Checkoutcode
uses:actions/checkout@v4

-name:ðŸ“¥Downloadbuildartifacts
uses:actions/download-artifact@v4
with:
name:build-artifacts
path:dist/

-name:ðŸš€DeploytoVercel/Netlify
id:deploy
run:|
echo"url=https://preview-${{github.event.number}}.vercel.app">>$GITHUB_OUTPUT
#Adicioneseucomandodedeployaqui

-name:ðŸ’¬CommentPRwithpreviewURL
uses:actions/github-script@v7
with:
script:|
github.rest.issues.createComment({
issue_number:context.issue.number,
owner:context.repo.owner,
repo:context.repo.repo,
body:`ðŸš€Previewdeployed!\n\nðŸ”—${{steps.deploy.outputs.url}}`
})

#============================================
#Job11:SuccessSummary
#============================================
success:
name:âœ…AllChecksPassed
runs-on:ubuntu-latest
needs:[lint,type-check,test,build,security]
if:success()

steps:
-name:ðŸŽ‰Success
run:|
echo"âœ…Allcheckspassedsuccessfully!"
echo"ðŸŽ‰Readytomerge!"
